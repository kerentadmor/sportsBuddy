<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SportsBuddy AI - ××•×¦× ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ</title>
    <meta name="description" content="××¦× ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ ×¢× ×‘×“×™×§×ª ××–×’ ××•×•×™×¨ ×—×›××”">
    <meta name="keywords" content="×¡×¤×•×¨×˜, ××ª×§× ×™×, ×™×©×¨××œ, ×‘×¨×™×›×”, ××•×œ× ×¡×¤×•×¨×˜, ×›×“×•×¨×’×œ">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            direction: rtl;
            padding: 10px;
        }

        .chat-container {
            width: min(450px, 100%);
            height: min(700px, 90vh);
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .new-chat-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 10px;
            border-radius: 15px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
        }

        .messages-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot { justify-content: flex-start; }
        .message.user { justify-content: flex-end; }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .message.bot .message-bubble {
            background: white;
            border: 1px solid #e1e8ed;
            margin-right: 8px;
        }

        .message.user .message-bubble {
            background: #4CAF50;
            color: white;
            margin-left: 8px;
        }

        .facility-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .facility-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .facility-type {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 11px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .facility-details {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        .facility-link {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 8px 12px;
            border-radius: 16px;
            text-decoration: none;
            font-size: 12px;
            margin-top: 10px;
            margin-left: 8px;
            transition: background 0.3s;
        }

        .facility-link:hover {
            background: #45a049;
        }

        .typing-indicator {
            display: none;
            padding: 10px 16px;
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 16px;
            margin-right: 8px;
            max-width: 60px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .input-container {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #e1e8ed;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 16px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            direction: rtl;
        }

        .message-input:focus {
            border-color: #4CAF50;
        }

        .send-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading-indicator {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .show-more-btn {
            background: #f0f8ff;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            margin: 10px 0;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
        }

        .show-more-btn:hover {
            background: #4CAF50;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #ffcdd2;
        }

        .off-topic-message {
            background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
            border: 2px solid #2196F3;
            padding: 12px;
            border-radius: 12px;
            margin: 10px 0;
            font-size: 14px;
        }

        .sports-suggestion {
            background: linear-gradient(135deg, #e8f5e8, #f1f8e9);
            border: 2px solid #4CAF50;
            padding: 10px;
            border-radius: 10px;
            margin: 8px 0;
            font-size: 13px;
        }

        .connection-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            margin: 10px 0;
        }

        .connection-online {
            background: #e8f5e8;
            color: #2e7d2e;
            border: 1px solid #4CAF50;
        }

        .connection-offline {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }

        @media (max-width: 450px) {
            body {
                padding: 0;
            }
            
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <button class="new-chat-btn" onclick="startNewConversation()">ğŸ”„ ×©×™×—×” ×—×“×©×”</button>
            <div class="status-badge" id="statusBadge">××ª×—×‘×¨ ×œ×©×¨×ª...</div>
            <div class="header-title">SportsBuddy AI</div>
            <div class="header-subtitle">××•×¦× ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ - ×¢× ××–×’ ××•×•×™×¨ ×—×›×!</div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="message bot">
                <div class="message-bubble">
                    <div class="loading-indicator" id="loadingMessage">
                        ğŸ”„ ××ª×—×‘×¨ ×œ×©×¨×ª ×•××˜×¢×Ÿ × ×ª×•× ×™ ××ª×§× ×™ ×¡×¤×•×¨×˜...<br>
                        <div class="connection-status connection-offline" id="connectionStatus">
                            ğŸ“¡ ×‘×•×“×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜...
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="××ª×—×‘×¨ ×œ×©×¨×ª..." onkeypress="handleKeyPress(event)" disabled>
            <button class="send-btn" onclick="sendMessage()" disabled id="sendButton">
                â¤
            </button>
        </div>
    </div>

    <script>
        // ğŸŒ Global configuration for hosting
        const CONFIG = {
            // ğŸ“ Change this URL to your hosted JSON file location:
            DATA_URL: './sports_facilities.json', // For GitHub Pages: 'https://yourusername.github.io/sportsbuddy/sports_facilities.json'
            WEATHER_API_KEY: '0822972733a5c06eb6d8f1e51dc0cec3',
            WEATHER_API_URL: 'https://api.openweathermap.org/data/2.5/weather',
            RETRY_ATTEMPTS: 3,
            RETRY_DELAY: 2000
        };

        // Global variables
        let sportsData = [];
        let isDataLoaded = false;
        let dataSource = 'unknown';
        let isOnline = navigator.onLine;
        
        // Conversation state
        let conversationState = {
            intent: null,
            slots: {
                location: null,
                facility_type: null,
                accessibility: null,
                parking: null,
                lighting: null,
                time: null
            },
            weatherChecked: false,
            weatherData: null,
            searchResults: [],
            currentPage: 0,
            resultsPerPage: 3,
            showMorePerPage: 10
        };

        // Network status monitoring
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus(true);
            if (!isDataLoaded) {
                loadSportsData();
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus(false);
        });

        function updateConnectionStatus(online) {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;
            
            if (online) {
                statusEl.className = 'connection-status connection-online';
                statusEl.textContent = 'ğŸŒ ××—×•×‘×¨ ×œ××™× ×˜×¨× ×˜';
            } else {
                statusEl.className = 'connection-status connection-offline';
                statusEl.textContent = 'ğŸ“¡ ××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜';
            }
        }

        // Enhanced data loading with retry mechanism
        async function loadSportsData() {
            if (!isOnline) {
                showOfflineMessage();
                return;
            }

            updateStatusBadge('××ª×—×‘×¨ ×œ×©×¨×ª...');
            
            for (let attempt = 1; attempt <= CONFIG.RETRY_ATTEMPTS; attempt++) {
                try {
                    console.log(`ğŸ”„ Attempt ${attempt}/${CONFIG.RETRY_ATTEMPTS} - Loading data from: ${CONFIG.DATA_URL}`);
                    
                    updateStatusBadge(`×˜×•×¢×Ÿ × ×ª×•× ×™×... (${attempt}/${CONFIG.RETRY_ATTEMPTS})`);
                    
                    const response = await fetch(CONFIG.DATA_URL, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        cache: 'no-cache' // Always get fresh data
                    });

                    console.log(`ğŸ“¡ Response status: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log(`âœ… Data loaded successfully: ${data.length} facilities`);
                    
                    if (Array.isArray(data) && data.length > 0) {
                        // Validate data structure
                        const sampleFacility = data[0];
                        if (sampleFacility['×™×©×•×‘'] || sampleFacility['×¡×•×’ ××ª×§×Ÿ']) {
                            sportsData = data;
                            dataSource = CONFIG.DATA_URL;
                            isDataLoaded = true;
                            updateStatusBadge(`${sportsData.length} ××ª×§× ×™×`);
                            showSuccessMessage();
                            enableInterface();
                            updateConnectionStatus(true);
                            return;
                        } else {
                            throw new Error('× ×ª×•× ×™× ×œ× ×ª×§×™× ×™× - ××‘× ×” ×§×•×‘×¥ ×©×’×•×™');
                        }
                    } else {
                        throw new Error('×§×•×‘×¥ ×”× ×ª×•× ×™× ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ');
                    }

                } catch (error) {
                    console.error(`âŒ Attempt ${attempt} failed:`, error.message);
                    
                    if (attempt < CONFIG.RETRY_ATTEMPTS) {
                        updateStatusBadge(`×›×©×œ ×‘×˜×¢×™× ×” - ×× ×¡×” ×©×•×‘... (${attempt}/${CONFIG.RETRY_ATTEMPTS})`);
                        await new Promise(resolve => setTimeout(resolve, CONFIG.RETRY_DELAY));
                    } else {
                        console.error('ğŸ’¥ All attempts failed');
                        showErrorMessage(error.message);
                    }
                }
            }
        }

        function showOfflineMessage() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.innerHTML = `
                    ğŸ“¡ <strong>××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜</strong><br><br>
                    ×”××¤×œ×™×§×¦×™×” ×–×§×•×§×” ×œ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜ ×›×“×™ ×œ×˜×¢×•×Ÿ ××ª × ×ª×•× ×™ ×”××ª×§× ×™× ×•×œ×‘×“×•×§ ××–×’ ××•×•×™×¨.<br><br>
                    ğŸ”„ <strong>×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•×¨×¢× ×Ÿ ××ª ×”×“×£</strong>
                `;
            }
            updateStatusBadge('××•×¤×œ×™×™×Ÿ');
        }

        function showSuccessMessage() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.innerHTML = `
                    âœ… <strong>×©×œ×•×! ××™×š ×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×?</strong><br><br>
                    ×× ×™ SportsBuddy - ×”×‘×•×˜ ×©××ª××—×” ×‘××¦×™××ª ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ ×¢× ×‘×“×™×§×ª ××–×’ ××•×•×™×¨ ×—×›××”!<br><br>
                    <div class="connection-status connection-online">
                        ğŸŒ ××—×•×‘×¨ ×œ×©×¨×ª â€¢ ${sportsData.length} ××ª×§× ×™× ×–××™× ×™×
                    </div>
                    <br>
                    ğŸ’¬ <strong>×“×•×’×××•×ª ×œ×©××œ×•×ª ×©×× ×™ ×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ×™×”×Ÿ:</strong><br>
                    ğŸŠâ€â™‚ï¸ "×× ×™ ××—×¤×© ×‘×¨×™×›×” ×‘×ª×œ ××‘×™×‘"<br>
                    âš½ "××™×¤×” ×™×© ××’×¨×© ×›×“×•×¨×’×œ ×‘×—×™×¤×”?"<br>
                    ğŸŒ¤ï¸ "××” ××–×’ ×”××•×•×™×¨ ×‘×™×¨×•×©×œ×™×?"<br>
                    ğŸƒâ€â™‚ï¸ "××•×œ× ×¡×¤×•×¨×˜ ×¢× × ×’×™×©×•×ª ×‘×¨×—×•×‘×•×ª"<br><br>
                    <strong>×¤×©×•×˜ ×›×ª×•×‘ ××” ××ª×” ××—×¤×©!</strong>
                `;
            }
        }

        function showErrorMessage(errorDetails) {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.innerHTML = `
                    âŒ <strong>×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×</strong><br><br>
                    ×œ× ×”×¦×œ×—×ª×™ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª ×”× ×ª×•× ×™×. ×–×” ×™×›×•×œ ×œ×§×¨×•×ª ××”×¡×™×‘×•×ª ×”×‘××•×ª:<br><br>
                    ğŸ”§ <strong>×¤×ª×¨×•× ×•×ª ××•×¦×¢×™×:</strong><br>
                    â€¢ ×¨×¢× ×Ÿ ××ª ×”×“×£ (F5)<br>
                    â€¢ ×‘×“×•×§ ××ª ×—×™×‘×•×¨ ×”××™× ×˜×¨× ×˜<br>
                    â€¢ × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×›××” ×“×§×•×ª<br><br>
                    <div class="error-message">
                        <strong>×¤×¨×˜×™ ×”×©×’×™××”:</strong> ${errorDetails}
                    </div>
                    <button onclick="location.reload()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                        ğŸ”„ ×¨×¢× ×Ÿ ××ª ×”×“×£
                    </button>
                `;
            }
            updateStatusBadge('×©×’×™××” ×‘×˜×¢×™× ×”');
        }

        // Outdoor facilities that need weather check
        const OUTDOOR_FACILITIES = ['×›×“×•×¨×’×œ', '×˜× ×™×¡', '×›×“×•×¨×¢×£', '××™× ×™'];

        // Enhanced facility mappings
        const FACILITY_MAPPINGS = {
            '××•×œ×': ['××•×œ× ×¡×¤×•×¨×˜ ×§×˜×Ÿ', '××•×œ× ×¡×¤×•×¨×˜ ×‘×™× ×•× ×™', '××•×œ× ×¡×¤×•×¨×˜ ×’×“×•×œ', '××•×œ× ×”×ª×¢××œ×•×ª', '××•×œ× ×¡×¤×•×¨×˜', '××•×œ×'],
            '×¡×¤×•×¨×˜': ['××•×œ× ×¡×¤×•×¨×˜', '××’×¨×© ×¡×¤×•×¨×˜', '××ª×§×Ÿ ×¡×¤×•×¨×˜'],
            '×”×ª×¢××œ×•×ª': ['××•×œ× ×”×ª×¢××œ×•×ª', '××•×œ× ×¡×¤×•×¨×˜', '×”×ª×¢××œ×•×ª'],
            '×‘×¨×™×›×”': ['×‘×¨×™×›×ª ×©×—×™×” - 25X12.5 ×\'', '×‘×¨×™×›×ª ×©×—×™×” - 20X50 ×\'', '×‘×¨×™×›×ª ×©×—×™×” ×‘××™×“×•×ª ××—×¨×•×ª', '×‘×¨×™×›×ª ×©×—×™×”', '×‘×¨×™×›×”', '×‘×¨×™×›×ª'],
            '×©×—×™×™×”': ['×‘×¨×™×›×ª ×©×—×™×” - 25X12.5 ×\'', '×‘×¨×™×›×ª ×©×—×™×” - 20X50 ×\'', '×‘×¨×™×›×ª ×©×—×™×” ×‘××™×“×•×ª ××—×¨×•×ª', '×‘×¨×™×›×ª ×©×—×™×”', '×‘×¨×™×›×”', '×©×—×™×”'],
            '×©×—×™×”': ['×‘×¨×™×›×ª ×©×—×™×” - 25X12.5 ×\'', '×‘×¨×™×›×ª ×©×—×™×” - 20X50 ×\'', '×‘×¨×™×›×ª ×©×—×™×” ×‘××™×“×•×ª ××—×¨×•×ª', '×‘×¨×™×›×ª ×©×—×™×”', '×‘×¨×™×›×”', '×©×—×™×”'],
            '×›×“×•×¨×’×œ': ['××’×¨×© ×›×“×•×¨×’×œ', '××¦×˜×“×™×•×Ÿ ×›×“×•×¨×’×œ', '××’×¨×© ×¡×¤×•×¨×˜ ××©×•×œ×‘', '×›×“×•×¨×’×œ', '××’×¨×© ×“×©×'],
            '×›×“×•×¨×¡×œ': ['××’×¨×© ×›×“×•×¨×¡×œ', '××•×œ× ×¡×¤×•×¨×˜', '×›×“×•×¨×¡×œ'],
            '×˜× ×™×¡': ['××’×¨×© ×˜× ×™×¡', '×˜× ×™×¡'],
            '×›×“×•×¨×¢×£': ['××’×¨×© ×—×•×œ ×§×‘×•×¢ ×œ×›×“×•×¨×¢×£', '××’×¨×© ×›×“×•×¨×¢×£', '×›×“×•×¨×¢×£', '×—×•×œ'],
            '×›×•×©×¨': ['××›×•×Ÿ ×œ×›×•×©×¨ ×’×•×¤× ×™', '××ª×§×Ÿ ×¤×ª×•×— ×œ×›×•×©×¨ ×’×•×¤× ×™', '×›×•×©×¨', '×¤×™×˜× ×¡'],
            '××™× ×™': ['××’×¨×© ××™× ×™ ×¤×™×¥\'', '××™× ×™'],
            '×—×•×œ': ['××’×¨×© ×—×•×œ ×§×‘×•×¢', '×—×•×œ']
        };
        
        // Current date helper
        function getCurrentDate() {
            const now = new Date();
            const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'];
            const dayName = days[now.getDay()];
            const date = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            return `×™×•× ${dayName}, ${date}/${month}/${year}`;
        }

        // Weather API integration with enhanced error handling
        async function getWeatherDataForTime(cityName, requestedTime) {
            if (!isOnline) {
                console.log('âŒ No internet connection for weather');
                return null;
            }

            try {
                console.log('ğŸŒ¤ï¸ Fetching weather for:', cityName, 'at time:', requestedTime);
                
                const englishCityName = getEnglishCityName(cityName);
                console.log('ğŸŒ Using English city name:', englishCityName);
                
                const cleanCityName = englishCityName.replace(/[Ö¾\-]/, ' ').trim();
                
                const currentUrl = `${CONFIG.WEATHER_API_URL}?q=${encodeURIComponent(cleanCityName)}&appid=${CONFIG.WEATHER_API_KEY}&units=metric&lang=he`;
                console.log('ğŸ”— Weather API URL:', currentUrl);
                
                const response = await fetch(currentUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                console.log('ğŸ“¡ Weather API Response status:', response.status);
                
                if (!response.ok) {
                    console.log('âŒ Weather API failed:', response.status, response.statusText);
                    return null;
                }
                
                const data = await response.json();
                console.log('âœ… Weather data received:', data);
                
                return {
                    temp: Math.round(data.main.temp),
                    description: data.weather[0].description,
                    main: data.weather[0].main,
                    cityName: data.name,
                    forecastTime: requestedTime,
                    isForecast: false
                };
                
            } catch (error) {
                console.error('ğŸ’¥ Weather API error:', error);
                return null;
            }
        }

        // Legacy function for backward compatibility
        async function getWeatherData(cityName) {
            return await getWeatherDataForTime(cityName, '×¢×›×©×™×•');
        }

        // Convert Hebrew city names to English for weather API
        function getEnglishCityName(hebrewCity) {
            const cityTranslations = {
                '×ª×œ ××‘×™×‘-×™×¤×•': 'Tel Aviv',
                '×ª×œ ××‘×™×‘': 'Tel Aviv',
                '×™×¨×•×©×œ×™×': 'Jerusalem',
                '×—×™×¤×”': 'Haifa',
                '×‘××¨ ×©×‘×¢': 'Beer Sheva',
                '×¤×ª×— ×ª×§×•×•×”': 'Petah Tikva',
                '× ×ª× ×™×”': 'Netanya',
                '××©×“×•×“': 'Ashdod',
                '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ': 'Rishon LeZion',
                '×—×•×œ×•×Ÿ': 'Holon',
                '×¨×—×•×‘×•×ª': 'Rehovot'
            };
            
            return cityTranslations[hebrewCity] || hebrewCity;
        }

        // Context-aware weather feedback with time consideration
        function getContextualWeatherFeedback(weatherData) {
            if (!weatherData) return null;
            
            const { temp, main, description, cityName, forecastTime, isForecast } = weatherData;
            
            let timeContext = '';
            if (isForecast) {
                timeContext = ` ×œ${getTimeDisplayName(forecastTime)}`;
            } else if (forecastTime && forecastTime !== '×¢×›×©×™×•') {
                timeContext = ` (×ª×—×–×™×ª ×¢×‘×•×¨ ${getTimeDisplayName(forecastTime)} ××‘×•×¡×¡×ª ×¢×œ ××–×’ ××•×•×™×¨ × ×•×›×—×™)`;
            }
            
            let feedback = `ğŸŒ¤ï¸ <strong>××–×’ ×”××•×•×™×¨ ×‘${cityName}${timeContext}:</strong> ${temp}Â°C, ${description}<br><br>`;
            
            // Rain/Storm conditions
            if (main === 'Rain' || main === 'Thunderstorm' || main === 'Snow') {
                if (forecastTime === '××—×¨' || forecastTime === '××—×¨×ª×™×™×') {
                    feedback += 'ğŸŒ§ï¸ <strong>×¦×¤×•×™ ×’×©× â€“ ××•××œ×¥ ×œ×©×§×•×œ ××ª×§×Ÿ ×¡×¤×•×¨×˜ ××§×•×¨×”.</strong><br>';
                } else {
                    feedback += 'ğŸŒ§ï¸ <strong>×™×•×¨×“ ×’×©× ×›×¨×’×¢ â€“ ××•××œ×¥ ×œ×©×§×•×œ ××ª×§×Ÿ ×¡×¤×•×¨×˜ ××§×•×¨×”.</strong><br>';
                }
                feedback += '××ª×§× ×™× ××§×•×¨×™× ×›××• ××•×œ××•×ª ×¡×¤×•×¨×˜ ×•×‘×¨×™×›×•×ª ×™×”×™×• ××™×“×™××œ×™×™×!';
            }
            // Extreme heat
            else if (temp > 32) {
                if (forecastTime && forecastTime !== '×¢×›×©×™×•') {
                    feedback += 'ğŸ”¥ <strong>×¦×¤×•×™ ×—×•× ×§×™×¦×•× ×™. ××•××œ×¥ ×œ×”×™×–×”×¨ ××”×©××©, ×œ×©×ª×•×ª ×”×¨×‘×” ××™×, ×•×œ×”×ª×××Ÿ ×‘×©×¢×•×ª ×”×§×¨×™×¨×•×ª ×™×•×ª×¨.</strong><br><br>';
                } else {
                    feedback += 'ğŸ”¥ <strong>×—×•× ×§×™×¦×•× ×™ ×›×¨×’×¢. ××•××œ×¥ ×œ×”×™×–×”×¨ ××”×©××©, ×œ×©×ª×•×ª ×”×¨×‘×” ××™×, ×•×œ×”×ª×××Ÿ ×‘×©×¢×•×ª ×”×§×¨×™×¨×•×ª ×™×•×ª×¨.</strong><br><br>';
                }
                feedback += 'ğŸ’¡ ×©×§×•×œ ×œ×—×¤×© ××ª×§×Ÿ ××§×•×¨×” ××• ×œ×ª×›× ×Ÿ ×¤×¢×™×œ×•×ª ×‘×©×¢×•×ª ×”×‘×•×§×¨ ×”××•×§×“××•×ª!';
            }
            // Very cold
            else if (temp < 10) {
                if (forecastTime && forecastTime !== '×¢×›×©×™×•') {
                    feedback += 'ğŸ¥¶ <strong>×¦×¤×•×™ ×§×•×¨ - ×”×§×¤×“ ×œ×”×ª×—×× ×”×™×˜×‘ ×œ×¤× ×™ ×”×¤×¢×™×œ×•×ª ×•×œ×”×œ×‘×™×© ×©×›×‘×•×ª.</strong><br>';
                } else {
                    feedback += 'ğŸ¥¶ <strong>×§×¨ ×‘×—×•×¥ - ×”×§×¤×“ ×œ×”×ª×—×× ×”×™×˜×‘ ×œ×¤× ×™ ×”×¤×¢×™×œ×•×ª ×•×œ×”×œ×‘×™×© ×©×›×‘×•×ª.</strong><br>';
                }
                feedback += '××ª×§× ×™× ××§×•×¨×™× ×™×”×™×• × ×•×—×™× ×™×•×ª×¨ ×‘××–×’ ××•×•×™×¨ ×›×–×”.';
            }
            // Perfect weather
            else if (temp >= 18 && temp <= 25) {
                if (forecastTime && forecastTime !== '×¢×›×©×™×•') {
                    feedback += 'â˜€ï¸ <strong>×¦×¤×•×™ ××–×’ ××•×•×™×¨ ××•×©×œ× - ××¤×©×¨ ×œ×”×ª×××Ÿ ×‘×›×œ ××§×•×!</strong><br>';
                } else {
                    feedback += 'â˜€ï¸ <strong>××–×’ ××•×•×™×¨ ××•×©×œ× - ××¤×©×¨ ×œ×”×ª×××Ÿ ×‘×›×œ ××§×•×!</strong><br>';
                }
                feedback += '×ª× ××™× ××™×“×™××œ×™×™× ×œ×¤×¢×™×œ×•×ª ×‘×—×•×¥ - ××’×¨×©×™ ×›×“×•×¨×’×œ, ×˜× ×™×¡, ××• ×›×œ ×¤×¢×™×œ×•×ª ××—×¨×ª!';
            }
            // Warm but manageable
            else {
                if (forecastTime && forecastTime !== '×¢×›×©×™×•') {
                    feedback += 'ğŸŒ¤ï¸ <strong>×¦×¤×•×™ ××–×’ ××•×•×™×¨ × ×¢×™× ×œ×¤×¢×™×œ×•×ª ×‘×—×•×¥.</strong><br>';
                } else {
                    feedback += 'ğŸŒ¤ï¸ <strong>××–×’ ××•×•×™×¨ × ×¢×™× ×œ×¤×¢×™×œ×•×ª ×‘×—×•×¥.</strong><br>';
                }
                if (temp > 28) {
                    feedback += 'ğŸ’§ ×¨×§ ×–×›×•×¨ ×œ×©×ª×•×ª ××™× ×‘××”×œ×š ×”×¤×¢×™×œ×•×ª.';
                } else {
                    feedback += '×ª× ××™× ×˜×•×‘×™× ×œ×›×œ ×¡×•×’×™ ×”×¤×¢×™×œ×•×™×•×ª!';
                }
            }
            
            return feedback;
        }

        function getTimeDisplayName(timeCategory) {
            const names = {
                '×‘×•×§×¨': '×‘×‘×•×§×¨',
                '×¦×”×¨×™×™×': '×‘×¦×”×¨×™×™×', 
                '××—×¨ ×”×¦×”×¨×™×™×': '××—×¨ ×”×¦×”×¨×™×™×',
                '×¢×¨×‘': '×‘×¢×¨×‘',
                '×œ×™×œ×”': '×‘×œ×™×œ×”',
                '×¢×›×©×™×•': '×›×¢×ª',
                '×”×™×•×': '×”×™×•×',
                '××—×¨': '××—×¨',
                '××—×¨×ª×™×™×': '××—×¨×ª×™×™×',
                '×”×©×‘×•×¢': '×”×©×‘×•×¢',
                '×¡×•×£ ×”×©×‘×•×¢': '×‘×¡×•×£ ×”×©×‘×•×¢',
                '×‘×¢×•×“ ×©×¢×”': '×‘×¢×•×“ ×©×¢×”',
                '×‘×¢×•×“ ×©×¢×ª×™×™×': '×‘×¢×•×“ ×©×¢×ª×™×™×'
            };
            return names[timeCategory] || timeCategory;
        }

        // Enhanced intent recognition with comprehensive off-topic detection
        function recognizeIntent(message) {
            const msgLower = message.toLowerCase();
            console.log('ğŸ” Analyzing message:', msgLower); // Debug log
            
            // Basic small talk and functionality patterns
            const basicPatterns = {
                greeting: ['×©×œ×•×', '×”×™×™', '×”×™', '×‘×•×§×¨ ×˜×•×‘', '×¢×¨×‘ ×˜×•×‘', '×œ×™×œ×” ×˜×•×‘'],
                thanks: ['×ª×•×“×”', '×ª×•×“×” ×¨×‘×”', 'thanks', '×× ×™ ××•×“×”', '×ª×•×“×•×ª'],
                how_are_you: ['××” × ×©××¢', '××™×š ×”×•×œ×š', '××” ×©×œ×•××š', '××™×š ××ª×” ××¨×’×™×©', '××™×š ××ª×”', '××” ×”××¦×‘', '××™×š ×”×—×™×™×'],
                what_day: ['××™×–×” ×™×•×', '××” ×”×™×•×', '××” ×”×ª××¨×™×š', '××™×–×” ×ª××¨×™×š'],
                capabilities: ['××” ××ª×” ×™×›×•×œ', '××™ ××ª×”', '××” ××ª×” ×¢×•×©×”', '××™×š ××ª×” ×¢×•×‘×“', '××” ×”×ª×—×•× ×©×œ×š'],
                weather_specific: ['××” ××–×’ ×”××•×•×™×¨', '××™×š ××–×’ ×”××•×•×™×¨', '××–×’ ××•×•×™×¨', '××–×’ ×”××•×•×™×¨ ×”×™×•×', '××™×š ××–×’ ×”××•×•×™×¨ ×”×™×•×'],
                show_more: ['×¢×•×“', '×”×¦×’ ×¢×•×“', '×¢×•×“ ××ª×§× ×™×', '×”××©×š', '×™×•×ª×¨', '×ª×Ÿ ×œ×™ ×¢×•×“']
            };

            // Comprehensive off-topic detection patterns
            const offTopicPatterns = {
                politics: [
                    '×¨××© ×”×××©×œ×”', '× ×ª× ×™×”×•', '×‘× ×˜', '×œ×¤×™×“', '×’× ×¥', '×¤×•×œ×™×˜×™×§×”', '×‘×—×™×¨×•×ª', '××¤×œ×’×”', '×›× ×¡×ª', 
                    '×××©×œ×”', '×©×¨', '×©×¨×”', '××™× ×™×¡×˜×¨', '× ×©×™×', '×”×¨×¦×•×’', '×¨×™×‘×œ×™×Ÿ', '×§×•××œ×™×¦×™×”', '××•×¤×•×–×™×¦×™×”',
                    '×œ×™×›×•×“', '×›×—×•×œ ×œ×‘×Ÿ', '×™×© ×¢×ª×™×“', '××¨×¥', '×”×¢×‘×•×“×”', '×™×©×¨××œ ×‘×™×ª× ×•', '×”×‘×™×ª ×”×™×”×•×“×™'
                ],
                personal_info: [
                    '××™×š ×§×•×¨××™× ×œ×™', '××” ×”×©× ×©×œ×™', '××™ ×× ×™', '××™×¤×” ×× ×™ ×’×¨', '×‘×Ÿ ×›××” ×× ×™', '××” ×”×’×™×œ ×©×œ×™',
                    '××™×¤×” ×× ×™ ×¢×•×‘×“', '××” ×”×¢×‘×•×“×” ×©×œ×™', '××™×¤×” ×× ×™ ×œ×•××“', '××” ×× ×™ ×œ×•××“', '××™×š ×× ×™ × ×¨××”',
                    '××” ×”×˜×œ×¤×•×Ÿ ×©×œ×™', '××” ×”××™××™×™×œ ×©×œ×™', '××™×¤×” ×× ×™ × ××¦×'
                ],
                general_questions: [
                    '××” ×”×©×¢×”', '×›××” ×”×©×¢×”', '××™×–×” ×©×¢×”', '××ª×™ ×–×”', '×›××” ×–×” ×¢×•×œ×”', '××™×š ×× ×™ ××’×™×¢ ×œ',
                    '××™×š × ×•×¡×¢×™× ×œ', '××” ×”××•×˜×•×‘×•×¡', '××™×–×” ×¨×›×‘×ª', '××™×š ×”×“×¨×š ×œ', '××™×¤×” ×–×” × ××¦×',
                    '××” ×”××¨×—×§', '×›××” ×–××Ÿ ×–×” ×œ×•×§×—', '××™×š ××’×™×¢×™×', '××™×š ×× ×™ ×™×›×•×œ ×œ×”×’×™×¢'
                ],
                health_medical: [
                    '×›×•××‘ ×œ×™', '×™×© ×œ×™ ×›××‘', '××” ×œ×¢×©×•×ª ×¢×', '××™×š ×œ×¨×¤×', '××™×š ×œ×˜×¤×œ', '×¨×•×¤×', '×¨×¤×•××”',
                    '×‘×™×ª ×—×•×œ×™×', '×§×•×¤×ª ×—×•×œ×™×', '×‘×™×˜×•×— ×‘×¨×™××•×ª', '×ª×¨×•×¤×”', '×ª×¨×•×¤×•×ª', '×›××‘ ×¨××©',
                    '×›××‘ ×‘×˜×Ÿ', '×©×¤×¢×ª', '×§×•×¨×•× ×”', '×§×•×‘×™×“', '×—×™×¡×•×Ÿ', '×—×™×¡×•× ×™×'
                ],
                food_recipes: [
                    '××ª×›×•×Ÿ ×œ', '××™×š ××›×™× ×™×', '××™×š ××‘×©×œ×™×', '××™×š ××•×¤×™×', '××” ×œ×‘×©×œ', '××” ×œ××›×•×œ',
                    '××™×¤×” ×œ××›×•×œ', '××¡×¢×“×”', '××¡×¢×“×•×ª', '××•×›×œ', '××¨×•×—×”', '××¨×•×—×ª', '×‘×™×©×•×œ', '××¤×™×™×”',
                    '×¢×•×’×”', '×¢×•×’×•×ª', '×¢×•×£', '×‘×©×¨', '×“×’', '×™×¨×§×•×ª', '×¤×™×¨×•×ª', '×§×™× ×•×—'
                ],
                technology: [
                    '××™×š ×œ×ª×§×Ÿ', '×”××—×©×‘ ×©×œ×™', '×”×˜×œ×¤×•×Ÿ ×©×œ×™', '×”××¤×œ×™×§×¦×™×”', '×”×•×•××˜×¡××¤', '××™× ×¡×˜×’×¨×',
                    '×¤×™×™×¡×‘×•×§', '×’×•×’×œ', '×™×•×˜×™×•×‘', '× ×˜×¤×œ×™×§×¡', '××™×š ×œ×”×•×¨×™×“', '××™×š ×œ×”×ª×§×™×Ÿ',
                    '×•×™×¨×•×¡', '×”××§×¨', '×¡×™×¡××”', '×¡×™×¡×××•×ª', '×©×›×—×ª×™ ××ª ×”×¡×™×¡××”'
                ],
                work_study: [
                    '××™×š ×œ××¦×•× ×¢×‘×•×“×”', '××™×¤×” ×œ×¢×‘×•×“', '××™×š ×œ×›×ª×•×‘ ×§×•×¨×•×ª ×—×™×™×', '×¨××™×•×Ÿ ×¢×‘×•×“×”',
                    '××™×š ×œ×œ××•×“', '××™×¤×” ×œ×œ××•×“', '××•× ×™×‘×¨×¡×™×˜×”', '××›×œ×œ×”', '×ª×•××¨', '×ª××¨×™×',
                    '××‘×—×Ÿ', '××‘×—× ×™×', '×‘×’×¨×•×™×•×ª', '×¤×¡×™×›×•××˜×¨×™', '××œ×’×”', '××œ×’×•×ª'
                ],
                entertainment: [
                    '××™×–×” ×¡×¨×˜', '××™×–×” ×¡×“×¨×”', '××” ×œ×¨××•×ª', '×§×•×œ× ×•×¢', '×ª×™××˜×¨×•×Ÿ', '×”×•×¤×¢×”', '×§×•× ×¦×¨×˜',
                    '××™×–×” ×©×™×¨', '××™×–×” ××•×–×™×§×”', '×–××¨', '×–××¨×ª', '×œ×”×§×”', '×××Ÿ', '××× ×™×ª'
                ],
                shopping: [
                    '××™×¤×” ×œ×§× ×•×ª', '×›××” ×¢×•×œ×”', '××™×–×” ××—×™×¨', '×”× ×—×”', '×”× ×—×•×ª', '××‘×¦×¢', '××‘×¦×¢×™×',
                    '×§× ×™×•×Ÿ', '×§× ×™×•×ª', '×—× ×•×ª', '×—× ×•×™×•×ª', '××•× ×œ×™×™×Ÿ', '××™× ×˜×¨× ×˜', '××©×œ×•×—'
                ],
                religion: [
                    '××ª×™ ×©×‘×ª', '××ª×™ ×—×’', '××™×–×” ×—×’', '×›×©×¨×•×ª', '×›×©×¨', '×”×œ×›×”', '×¨×‘', '×¨×‘× ×•×ª',
                    '×‘×™×ª ×›× ×¡×ª', '×ª×¤×™×œ×”', '×ª×¤×™×œ×•×ª', '×ª×•×¨×”', '××¦×•×•×”', '×‘×¨ ××¦×•×•×”', '×‘×ª ××¦×•×•×”'
                ],
                news_current_events: [
                    '××” ×§×•×¨×”', '××” ×”×—×“×©×•×ª', '××” ×”×œ×™×œ×”', '××™×š ×”×©×•×§', '××” ×‘×‘×•×¨×¡×”', '×“×•×œ×¨',
                    '××™×¨×•', '×©×§×œ', '××˜×‘×¢', '×—×“×©×•×ª', '×¢×“×›×•× ×™×', '×¢×“×›×•×Ÿ', '×˜×œ×•×•×™×–×™×”'
                ]
            };

            // Check for basic patterns first
            for (const [intent, patterns] of Object.entries(basicPatterns)) {
                for (const pattern of patterns) {
                    if (msgLower.includes(pattern)) {
                        console.log('âœ… Found basic pattern:', pattern, 'â†’', intent);
                        return intent;
                    }
                }
            }

            // Check for off-topic patterns with specific categories
            for (const [category, patterns] of Object.entries(offTopicPatterns)) {
                for (const pattern of patterns) {
                    if (msgLower.includes(pattern)) {
                        console.log('ğŸš« Found off-topic pattern:', pattern, 'â†’', `off_topic_${category}`);
                        return `off_topic_${category}`;
                    }
                }
            }

            // Sport facility related patterns (only check if no off-topic found)
            const searchPatterns = ['××—×¤×©', '×¨×•×¦×”', '×× ×™ ×¨×•×¦×”', '×¦×¨×™×š', '××™×¤×”', '×œ××¦×•×', '×ª××¦× ×œ×™', '×ª×—×¤×© ×œ×™'];
            const facilityPatterns = [
                '××•×œ×', '×‘×¨×™×›×”', '××’×¨×©', '×¡×¤×•×¨×˜', '×›×“×•×¨×’×œ', '×˜× ×™×¡', '×›×“×•×¨×¡×œ', '×›×“×•×¨×¢×£',
                '×©×—×™×™×”', '×”×ª×¢××œ×•×ª', '×›×•×©×¨', '×¤×™×˜× ×¡', '×¨×™×¦×”', '××™××•×Ÿ', '××™××•× ×™×', '×¤×¢×™×œ×•×ª',
                '××ª×§×Ÿ', '××ª×§× ×™×', '××§×•× ×œ×¡×¤×•×¨×˜', '××§×•× ×œ×”×ª×××Ÿ'
            ];

            // Check if it's a sports facility search
            const hasSearchPattern = searchPatterns.some(p => msgLower.includes(p));
            const hasFacilityPattern = facilityPatterns.some(p => msgLower.includes(p));
            
            if (hasSearchPattern || hasFacilityPattern) {
                console.log('ğŸƒâ€â™‚ï¸ Found sports facility pattern â†’ search_facility');
                return 'search_facility';
            }

            // If none of the above, assume it's off-topic general
            console.log('â“ No specific pattern found â†’ off_topic_general');
            return 'off_topic_general';
        }

        async function handleSmallTalk(intent, message) {
            console.log('ğŸ­ handleSmallTalk called with intent:', intent); // Debug log
            
            const responses = {
                greeting: '×©×œ×•× ×•×‘×¨×›×”! ğŸ˜Š ××™×š ××¤×©×¨ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª×§×Ÿ ×¡×¤×•×¨×˜ ×”×™×•×?',
                thanks: '×ª××™×“ ×‘×©××—×”! ğŸ™Œ ×× ×™ ×›××Ÿ ×× ×ª×¦×˜×¨×š ××ª×§×Ÿ ×¡×¤×•×¨×˜ ×›×œ×©×”×•.',
                how_are_you: '×”×›×œ ××¦×•×™×Ÿ, ×ª×•×“×” ×©×©××œ×ª! ğŸ˜Š ××•×›×Ÿ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª×§×Ÿ ×¡×¤×•×¨×˜ × ×”×“×¨!',
                what_day: `×”×™×•× ${getCurrentDate()} ğŸ“… ×™×•× × ×”×“×¨ ×œ×¤×¢×™×œ×•×ª ×¡×¤×•×¨×˜! ×¨×•×¦×” ×©×××¦× ×œ×š ××ª×§×Ÿ?`,
                capabilities: '×× ×™ ×¦\'××˜ ×‘×•×˜ ×©××ª××—×” ×‘×¢×–×¨×” ×¢× ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ ğŸ¤¸â€â™‚ï¸<br>×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª×§× ×™× ×•×œ×‘×“×•×§ ××–×’ ××•×•×™×¨!'
            };

            // Enhanced off-topic responses with specific guidance
            const offTopicResponses = {
                off_topic_politics: '<div class="off-topic-message">ğŸ—³ï¸ ×× ×™ ×œ× ××˜×¤×œ ×‘× ×•×©××™× ×¤×•×œ×™×˜×™×™× - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×× ×™ ××•××—×” ×‘××¦×™××ª ××ª×§× ×™ ×¡×¤×•×¨×˜!</strong><br>ğŸ’¬ ×‘×•× × ××¦× ×œ×š ××§×•× ×œ×”×ª×××Ÿ - ××™×–×” ×¡×•×’ ×¡×¤×•×¨×˜ ××ª×” ××•×”×‘?</div>',
                
                off_topic_personal_info: '<div class="off-topic-message">ğŸ¤ ×× ×™ ×œ× ×™×›×•×œ ×œ×“×¢×ª ××™×“×¢ ××™×©×™ ×¢×œ×™×š - ×–×” ×œ× × ×’×™×© ×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×× ×™ ×›×Ÿ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª×§× ×™ ×¡×¤×•×¨×˜!</strong><br>ğŸ’¬ ××™×–×” ×¤×¢×™×œ×•×ª ×¡×¤×•×¨×˜ ××¢× ×™×™× ×ª ××•×ª×š? ×‘×¨×™×›×”? ××•×œ× ×¡×¤×•×¨×˜? ××’×¨×© ×›×“×•×¨×’×œ?</div>',
                
                off_topic_general_questions: '<div class="off-topic-message">â“ ×–×” ×œ× ×‘×ª×—×•× ×”×”×ª××—×•×ª ×©×œ×™...</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>×× ×™ ××ª××—×” ×‘××¦×™××ª ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ!</strong><br>ğŸ’¡ ×™×© ×œ×š ×¦×•×¨×š ×‘××ª×§×Ÿ ×¡×¤×•×¨×˜? ×× ×™ ××©××— ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ×‘×“×™×•×§ ××” ×©××ª×” ××—×¤×©!</div>',
                
                off_topic_health_medical: '<div class="off-topic-message">âš•ï¸ ×× ×™ ×œ× ×™×›×•×œ ×œ×ª×ª ×¢×¦×•×ª ×¨×¤×•××™×•×ª - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™ ×•×œ× ×‘×˜×•×—!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×× ×™ ×›×Ÿ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××§×•× ×œ×”×ª×××Ÿ!</strong><br>ğŸ’ª ×¤×¢×™×œ×•×ª ×¡×¤×•×¨×˜ ×–×” ××—×“ ×”×“×‘×¨×™× ×”×˜×•×‘×™× ×‘×™×•×ª×¨ ×œ×‘×¨×™××•×ª. ××™×–×” ×¡×•×’ ×¤×¢×™×œ×•×ª ××¢× ×™×™×Ÿ ××•×ª×š?</div>',
                
                off_topic_food_recipes: '<div class="off-topic-message">ğŸ³ ×× ×™ ×œ× ×©×£ - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×× ×™ ××•××—×” ×‘××¦×™××ª ××ª×§× ×™ ×¡×¤×•×¨×˜!</strong><br>ğŸ’¡ ××—×¨×™ ×©×ª×ª×××Ÿ, ×”××•×›×œ ×™×”×™×” ×˜×¢×™× ×”×¨×‘×” ×™×•×ª×¨! ×¨×•×¦×” ×©×××¦× ×œ×š ××§×•× ×œ×”×ª×××Ÿ?</div>',
                
                off_topic_technology: '<div class="off-topic-message">ğŸ’» ×× ×™ ×œ× ×˜×›× ××™ ××—×©×‘×™× - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>×× ×™ ××ª××—×” ×‘××¦×™××ª ××ª×§× ×™ ×¡×¤×•×¨×˜!</strong><br>ğŸ’¡ ××—×¨×™ ×›×œ ×”×–××Ÿ ××•×œ ×”××¡×›×™×, ××” ×“×¢×ª×š ×¢×œ ×§×¦×ª ×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª? ××™×–×” ×¡×¤×•×¨×˜ ××ª×” ××•×”×‘?</div>',
                
                off_topic_work_study: '<div class="off-topic-message">ğŸ“š ×× ×™ ×œ× ×™×•×¢×¥ ×ª×¢×¡×•×§×” ××• ×œ×™××•×“×™× - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××§×•× ×œ×”×¤×•×’ ×œ×—×¥ ×•×œ×”×ª×××Ÿ!</strong><br>ğŸ’ª ×¡×¤×•×¨×˜ ×–×” ×”×“×¨×š ×”×˜×•×‘×” ×‘×™×•×ª×¨ ×œ×”×ª××•×“×“ ×¢× ×œ×—×¥ ×‘×¢×‘×•×“×” ××• ×‘×œ×™××•×“×™×. ××” ×“×¢×ª×š?</div>',
                
                off_topic_entertainment: '<div class="off-topic-message">ğŸ¬ ×× ×™ ×œ× ××•××—×” ×œ×‘×™×“×•×¨ - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×™×© ×œ×™ ×¨×¢×™×•×Ÿ ×œ×‘×™×“×•×¨ ××¢×•×œ×” - ×¡×¤×•×¨×˜!</strong><br>ğŸ’¡ ×‘××§×•× ×œ×¦×¤×•×ª ×‘×¡×¨×˜, ××” ×“×¢×ª×š ×œ×”×™×•×ª ×”×›×•×›×‘? ××™×–×” ×¤×¢×™×œ×•×ª ×¡×¤×•×¨×˜ ××¢× ×™×™× ×ª ××•×ª×š?</div>',
                
                off_topic_shopping: '<div class="off-topic-message">ğŸ›ï¸ ×× ×™ ×œ× ××•××—×” ×œ×§× ×™×•×ª - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×™×© ×œ×™ ××©×”×• ×‘×—×™× × ×‘×©×‘×™×œ×š - ××™×“×¢ ×¢×œ ××ª×§× ×™ ×¡×¤×•×¨×˜!</strong><br>ğŸ’¡ ×”×¡×¤×•×¨×˜ ×”×›×™ ×˜×•×‘ ×–×” ×”×–×•×œ ×‘×™×•×ª×¨! ×¨×•×¦×” ×©×××¦× ×œ×š ××ª×§×Ÿ ×¦×™×‘×•×¨×™ ×œ×”×ª×××Ÿ?</div>',
                
                off_topic_religion: '<div class="off-topic-message">ğŸ•Šï¸ ×× ×™ ×œ× ×¢×•×¡×§ ×‘× ×•×©××™× ×“×ª×™×™× - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª×§× ×™ ×¡×¤×•×¨×˜!</strong><br>ğŸ’¡ ×™×© ××ª×§× ×™× ×©××ª×—×©×‘×™× ×‘×¦×¨×›×™× ×“×ª×™×™× - ×¨×•×¦×” ×©×××¦× ×œ×š ×›××œ×”?</div>',
                
                off_topic_news_current_events: '<div class="off-topic-message">ğŸ“º ×× ×™ ×œ× ×¢×•×§×‘ ××—×¨×™ ×—×“×©×•×ª - ×–×” ×œ× ×”×ª×—×•× ×©×œ×™!</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>××‘×œ ×™×© ×œ×™ ×—×“×©×•×ª ×˜×•×‘×•×ª - ×× ×™ ×™×›×•×œ ×œ××¦×•× ×œ×š ××ª×§× ×™ ×¡×¤×•×¨×˜ ××¢×•×œ×™×!</strong><br>ğŸ’ª ×‘××§×•× ×œ×“××•×’ ××”×—×“×©×•×ª, ××” ×“×¢×ª×š ×¢×œ ×§×¦×ª ×¤×¢×™×œ×•×ª ×’×•×¤× ×™×ª ×œ×”×™×¨×’×¢?</div>',
                
                off_topic_general: '<div class="off-topic-message">ğŸ¤” ×–×” ×œ× ×××© ×‘×ª×—×•× ×”×”×ª××—×•×ª ×©×œ×™...</div><div class="sports-suggestion">ğŸƒâ€â™‚ï¸ <strong>×× ×™ SportsBuddy - ×”×‘×•×˜ ×©×”×›×™ ×˜×•×‘ ×‘××¦×™××ª ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ!</strong><br>ğŸ’¡ ×™×© ×œ×š ×¦×•×¨×š ×‘××ª×§×Ÿ ×¡×¤×•×¨×˜? ×–×” ××” ×©×× ×™ ×”×›×™ ××•×”×‘ ×œ×¢×–×•×¨ ×‘×•! ××™×–×” ×¤×¢×™×œ×•×ª ××¢× ×™×™× ×ª ××•×ª×š?</div>'
            };
            
            // Handle weather-specific queries
            if (intent === 'weather_specific') {
                const location = findLocationInData(message);
                const timeFromMessage = extractTimeFromMessage(message) || '×¢×›×©×™×•';
                
                if (location) {
                    let weatherMessage = '×¨×’×¢ ××—×“, ×‘×•×“×§ ××ª ××–×’ ×”××•×•×™×¨';
                    if (timeFromMessage !== '×¢×›×©×™×•') {
                        weatherMessage += ` ×‘${location} ×œ${getTimeDisplayName(timeFromMessage)}`;
                    } else {
                        weatherMessage += ` ×‘${location}`;
                    }
                    weatherMessage += '... ğŸŒ¤ï¸';
                    
                    addMessage(weatherMessage, 'bot');
                    showTypingIndicator();
                    
                    const weatherData = await getWeatherDataForTime(location, timeFromMessage);
                    hideTypingIndicator();
                    
                    if (weatherData) {
                        const weatherMessage = getContextualWeatherFeedback(weatherData);
                        addMessage(weatherMessage, 'bot');
                        
                        // Add sports recommendation after weather
                        setTimeout(() => {
                            addMessage('ğŸ’¡ <strong>××•×›×Ÿ ×œ××¦×•× ××ª×§×Ÿ ×¡×¤×•×¨×˜ ××ª××™× ×œ××–×’ ×”××•×•×™×¨?</strong><br>×¤×©×•×˜ ×›×ª×•×‘ ××™×–×” ×¡×•×’ ×¤×¢×™×œ×•×ª ××ª×” ××—×¤×©! ğŸƒâ€â™‚ï¸', 'bot');
                        }, 1000);
                    } else {
                        addMessage(`××¦×˜×¢×¨, ×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ × ×ª×•× ×™ ××–×’ ××•×•×™×¨ ×¢×‘×•×¨ ${location} ×›×¨×’×¢. ğŸ˜•<br><br>ğŸ’¡ <strong>××‘×œ ×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª×§× ×™ ×¡×¤×•×¨×˜!</strong><br>××™×–×” ×¡×•×’ ×¤×¢×™×œ×•×ª ××¢× ×™×™×Ÿ ××•×ª×š?`, 'bot');
                    }
                } else {
                    addMessage('××™×¤×” ××ª×” ×¨×•×¦×” ×œ×‘×“×•×§ ××ª ××–×’ ×”××•×•×™×¨? ğŸŒ¤ï¸<br><br>ğŸ’¬ ×œ×“×•×’××”: "××” ××–×’ ×”××•×•×™×¨ ×‘×ª×œ ××‘×™×‘?"<br><br>ğŸƒâ€â™‚ï¸ <strong>×•××—×¨ ×›×š ×× ×™ ××©××— ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª×§×Ÿ ×¡×¤×•×¨×˜ ××ª××™×!</strong>', 'bot');
                }
                return null;
            }
            
            // Handle all off-topic intents
            if (intent.startsWith('off_topic_')) {
                console.log('ğŸš« Handling off-topic intent:', intent);
                const response = offTopicResponses[intent];
                console.log('ğŸ“ Found response:', response ? 'Yes' : 'No');
                return response || offTopicResponses.off_topic_general;
            }
            
            // Return basic responses for recognized intents
            const response = responses[intent];
            console.log('ğŸ“ Basic response found:', response ? 'Yes' : 'No');
            return response || offTopicResponses.off_topic_general;
        }

        function findLocationInData(message) {
            if (!sportsData || sportsData.length === 0) return null;
            
            const msgLower = message.toLowerCase();
            const settlements = [...new Set(sportsData.map(f => f['×™×©×•×‘']).filter(Boolean))];
            
            // Try to find location in data
            for (const settlement of settlements) {
                if (msgLower.includes(settlement.toLowerCase())) {
                    return settlement;
                }
            }
            
            // Enhanced city patterns with English names for weather API
            const cityPatterns = {
                '×ª×œ ××‘×™×‘-×™×¤×•': ['×ª×œ ××‘×™×‘', '×ª×', 'tel aviv'],
                '×™×¨×•×©×œ×™×': ['×™×¨×•×©×œ×™×', 'jerusalem'],
                '×—×™×¤×”': ['×—×™×¤×”', 'haifa'],
                '×‘××¨ ×©×‘×¢': ['×‘××¨ ×©×‘×¢', 'beer sheva'],
                '×¤×ª×— ×ª×§×•×•×”': ['×¤×ª×— ×ª×§×•×•×”', 'petah tikva'],
                '× ×ª× ×™×”': ['× ×ª× ×™×”', 'netanya'],
                '××©×“×•×“': ['××©×“×•×“', 'ashdod'],
                '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ': ['×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ', 'rishon lezion'],
                '×—×•×œ×•×Ÿ': ['×—×•×œ×•×Ÿ', 'holon'],
                '×¨×—×•×‘×•×ª': ['×¨×—×•×‘×•×ª', 'rehovot']
            };
            
            for (const [city, patterns] of Object.entries(cityPatterns)) {
                if (patterns.some(pattern => msgLower.includes(pattern))) {
                    return city;
                }
            }
            
            return null;
        }

        function findFacilityTypeInData(message) {
            const msgLower = message.toLowerCase();
            
            const searchPatterns = [
                { patterns: ['×‘×¨×™×›', '×©×—×™×™', '×©×—×™×”'], match: '×‘×¨×™×›×”' },
                { patterns: ['××•×œ×', '×”×ª×¢××œ×•×ª'], match: '××•×œ×' },
                { patterns: ['×›×“×•×¨×’×œ', '×“×©×'], match: '×›×“×•×¨×’×œ' },
                { patterns: ['×›×“×•×¨×¡×œ'], match: '×›×“×•×¨×¡×œ' },
                { patterns: ['×˜× ×™×¡'], match: '×˜× ×™×¡' },
                { patterns: ['×›×“×•×¨×¢×£', '×—×•×œ'], match: '×›×“×•×¨×¢×£' },
                { patterns: ['×›×•×©×¨', '×¤×™×˜× ×¡'], match: '×›×•×©×¨' }
            ];
            
            for (const { patterns, match } of searchPatterns) {
                if (patterns.some(pattern => msgLower.includes(pattern))) {
                    return match;
                }
            }
            
            return null;
        }

        // Enhanced information extraction
        function extractAllAvailableInfo(message) {
            const msgLower = message.toLowerCase();
            console.log('ğŸ” Comprehensive extraction from:', msgLower);
            
            const extractedInfo = {
                facility_type: null,
                location: null,
                time: null,
                accessibility: null,
                parking: null,
                lighting: null
            };
            
            extractedInfo.facility_type = findFacilityTypeInData(message);
            extractedInfo.location = findLocationInData(message);
            extractedInfo.time = extractTimeFromMessage(message);
            
            if (msgLower.includes('× ×’×™×©') || msgLower.includes('××•×’×‘×œ') || 
                msgLower.includes('×›×™×¡× ×’×œ×’×œ') || msgLower.includes('× ×›×™×')) {
                extractedInfo.accessibility = '×›×Ÿ';
            } else if (msgLower.includes('×œ× × ×’×™×©') || msgLower.includes('×‘×œ×™ × ×’×™×©')) {
                extractedInfo.accessibility = '×œ×';
            }
            
            if (msgLower.includes('×—× ×™') || msgLower.includes('×¨×›×‘') || 
                msgLower.includes('××§×•× ×—× ×™×”') || msgLower.includes('×¤××¨×§×™× ×’')) {
                extractedInfo.parking = '×›×Ÿ';
            } else if (msgLower.includes('×‘×œ×™ ×—× ×™') || msgLower.includes('×œ× ×—× ×™')) {
                extractedInfo.parking = '×œ×';
            }
            
            if (msgLower.includes('×ª××•×¨') || msgLower.includes('××•×¨') || 
                msgLower.includes('×œ×™×œ×”') || msgLower.includes('×‘×—×•×©×š') ||
                msgLower.includes('××•××¨')) {
                extractedInfo.lighting = '×›×Ÿ';
            } else if (msgLower.includes('×‘×œ×™ ×ª××•×¨') || msgLower.includes('×œ× ×ª××•×¨')) {
                extractedInfo.lighting = '×œ×';
            }
            
            if (!extractedInfo.facility_type) {
                if (msgLower.includes('×œ×©×—×•×ª') || msgLower.includes('×©×—×™×™×”')) {
                    extractedInfo.facility_type = '×‘×¨×™×›×ª ×©×—×™×” (50X20)';
                } else if (msgLower.includes('×œ×¨×•×¥') || msgLower.includes('×¨×™×¦×”') || msgLower.includes('×’\'×•×’×™× ×’')) {
                    extractedInfo.facility_type = '××¡×œ×•×œ ××ª×œ×˜×™×§×” ×§×œ×”';
                } else if (msgLower.includes('×œ×”×ª×××Ÿ') && !extractedInfo.facility_type) {
                    extractedInfo.facility_type = '××•×œ× ×¡×¤×•×¨×˜ ×‘×™× ×•× ×™';
                }
            }
            
            if (!extractedInfo.time) {
                if (msgLower.includes('×“×—×•×£') || msgLower.includes('××™×™×“×™') || msgLower.includes('××”×¨')) {
                    extractedInfo.time = '×¢×›×©×™×•';
                } else if (msgLower.includes('×©×‘×ª') || msgLower.includes('×¡×•×¤"×©') || msgLower.includes('×¡×•×£ ×”×©×‘×•×¢')) {
                    extractedInfo.time = '×¡×•×£ ×”×©×‘×•×¢';
                }
            }
            
            console.log('ğŸ“ Comprehensive extraction results:', extractedInfo);
            return extractedInfo;
        }

        function extractEntities(message) {
            const msgLower = message.toLowerCase();
            const entities = {};
            
            if (!conversationState.slots.facility_type) {
                entities.facility_type = findFacilityTypeInData(message);
            }
            
            if (!conversationState.slots.location) {
                entities.location = findLocationInData(message);
            }
            
            if (!conversationState.slots.time) {
                const timeEntity = extractTimeFromMessage(message);
                if (timeEntity) {
                    entities.time = timeEntity;
                }
            }
            
            const isYesResponse = msgLower.includes('×›×Ÿ') || msgLower.includes('yes') || 
                                msgLower.includes('×‘×•×•×“××™') || msgLower.includes('×—×©×•×‘ ×œ×™');
            const isNoResponse = msgLower.includes('×œ×') || msgLower.includes('no') || 
                               msgLower.includes('×œ× ×—×©×•×‘') || msgLower.includes('×‘×œ×™');
            
            if (msgLower.includes('× ×’×™×©') || msgLower.includes('××•×’×‘×œ') || msgLower.includes('×›×™×¡× ×’×œ×’×œ')) {
                entities.accessibility = '×›×Ÿ';
            } else if (msgLower.includes('×œ× × ×’×™×©') || msgLower.includes('×‘×œ×™ × ×’×™×©')) {
                entities.accessibility = '×œ×';
            } else if (conversationState.slots.accessibility === null) {
                if (isYesResponse) entities.accessibility = '×›×Ÿ';
                if (isNoResponse) entities.accessibility = '×œ×';
            }
            
            if (msgLower.includes('×—× ×™') || msgLower.includes('×¨×›×‘')) {
                entities.parking = '×›×Ÿ';
            } else if (msgLower.includes('×‘×œ×™ ×—× ×™') || msgLower.includes('×œ× ×—× ×™')) {
                entities.parking = '×œ×';
            } else if (conversationState.slots.parking === null && conversationState.slots.accessibility !== null) {
                if (isYesResponse) entities.parking = '×›×Ÿ';
                if (isNoResponse) entities.parking = '×œ×';
            }
            
            if (msgLower.includes('×ª××•×¨') || msgLower.includes('××•×¨') || msgLower.includes('×œ×™×œ×”')) {
                entities.lighting = '×›×Ÿ';
            } else if (msgLower.includes('×‘×œ×™ ×ª××•×¨') || msgLower.includes('×œ× ×ª××•×¨')) {
                entities.lighting = '×œ×';
            } else if (conversationState.slots.lighting === null && conversationState.slots.parking !== null) {
                if (isYesResponse) entities.lighting = '×›×Ÿ';
                if (isNoResponse) entities.lighting = '×œ×';
            }
            
            return entities;
        }

        function extractTimeFromMessage(message) {
            const msgLower = message.toLowerCase();
            
            const timePatterns = {
                '×¢×›×©×™×•': '×¢×›×©×™×•',
                '×›×¢×ª': '×¢×›×©×™×•', 
                '×¢×›×¡×™×•': '×¢×›×©×™×•',
                '××™×™×“×™': '×¢×›×©×™×•',
                '×“×—×•×£': '×¢×›×©×™×•',
                '××”×¨': '×¢×›×©×™×•',
                '×”×™×•×': '×”×™×•×',
                '×”×œ×™×œ×”': '×œ×™×œ×”',
                '×”×¢×¨×‘': '×¢×¨×‘',
                '×”×‘×•×§×¨': '×‘×•×§×¨',
                '××—×¨': '××—×¨',
                '××—×¨×ª×™×™×': '××—×¨×ª×™×™×',
                '×‘×¢×¨×‘': '×¢×¨×‘',
                '×‘×‘×•×§×¨': '×‘×•×§×¨',
                '×‘×¦×”×¨×™×™×': '×¦×”×¨×™×™×',
                '××—×¨ ×”×¦×”×¨×™×™×': '××—×¨ ×”×¦×”×¨×™×™×',
                '××—×¨×™ ×”×¦×”×¨×™×™×': '××—×¨ ×”×¦×”×¨×™×™×',
                '×‘×œ×™×œ×”': '×œ×™×œ×”',
                '×”×©×‘×•×¢': '×”×©×‘×•×¢',
                '×¡×•×£ ×”×©×‘×•×¢': '×¡×•×£ ×”×©×‘×•×¢',
                '×¡×•×¤"×©': '×¡×•×£ ×”×©×‘×•×¢',
                '×‘×¡×•×¤"×©': '×¡×•×£ ×”×©×‘×•×¢',
                '×©×‘×ª': '×¡×•×£ ×”×©×‘×•×¢',
                '×‘×©×‘×ª': '×¡×•×£ ×”×©×‘×•×¢',
                '×™×•× ×©×™×©×™': '×¡×•×£ ×”×©×‘×•×¢',
                '×™×•× ×©×‘×ª': '×¡×•×£ ×”×©×‘×•×¢',
                '×‘×¢×•×“ ×©×¢×”': '×‘×¢×•×“ ×©×¢×”',
                '×‘×¢×•×“ ×©×¢×ª×™×™×': '×‘×¢×•×“ ×©×¢×ª×™×™×',
                '×ª×•×š ×›×“×™': '×¢×›×©×™×•',
                '×›×¨×’×¢': '×¢×›×©×™×•',
                '×‘××”×œ×š ×”×™×•×': '×”×™×•×',
                '×‘××”×œ×š ×”×¢×¨×‘': '×¢×¨×‘',
                '×œ××—×¨': '××—×¨',
                '×œ××—×¨×ª': '××—×¨'
            };
            
            for (const [pattern, normalized] of Object.entries(timePatterns)) {
                if (msgLower.includes(pattern)) {
                    console.log('â° Found time pattern:', pattern, 'â†’', normalized);
                    return normalized;
                }
            }
            
            const hourMatches = msgLower.match(/(?:×‘×©×¢×”|×‘[Ö¾\-]?)(\d{1,2})/);
            if (hourMatches) {
                const hour = parseInt(hourMatches[1]);
                if (hour >= 6 && hour <= 11) return '×‘×•×§×¨';
                if (hour >= 12 && hour <= 17) return '×¦×”×¨×™×™×';
                if (hour >= 18 && hour <= 22) return '×¢×¨×‘';
                if (hour >= 23 || hour <= 5) return '×œ×™×œ×”';
            }
            
            const dayPatterns = [
                { pattern: /×‘×™×•× ×¨××©×•×Ÿ|×™×•× ×¨××©×•×Ÿ/i, value: '×”×©×‘×•×¢' },
                { pattern: /×‘×™×•× ×©× ×™|×™×•× ×©× ×™/i, value: '×”×©×‘×•×¢' },
                { pattern: /×‘×™×•× ×©×œ×™×©×™|×™×•× ×©×œ×™×©×™/i, value: '×”×©×‘×•×¢' },
                { pattern: /×‘×™×•× ×¨×‘×™×¢×™|×™×•× ×¨×‘×™×¢×™/i, value: '×”×©×‘×•×¢' },
                { pattern: /×‘×™×•× ×—××™×©×™|×™×•× ×—××™×©×™/i, value: '×”×©×‘×•×¢' },
                { pattern: /×‘×™×•× ×©×™×©×™|×™×•× ×©×™×©×™/i, value: '×¡×•×£ ×”×©×‘×•×¢' },
                { pattern: /×‘×™×•× ×©×‘×ª|×™×•× ×©×‘×ª/i, value: '×¡×•×£ ×”×©×‘×•×¢' }
            ];
            
            for (const dayPattern of dayPatterns) {
                if (dayPattern.pattern.test(message)) {
                    console.log('ğŸ“… Found day pattern:', dayPattern.value);
                    return dayPattern.value;
                }
            }
            
            return null;
        }

        function updateSlots(entities) {
            for (const [key, value] of Object.entries(entities)) {
                if (value && conversationState.slots[key] === null) {
                    conversationState.slots[key] = value;
                }
            }
        }

        function getMissingSlots() {
            const required = ['location', 'facility_type', 'time', 'accessibility', 'parking', 'lighting'];
            return required.filter(slot => conversationState.slots[slot] === null);
        }

        function askForMissingInfo(missingSlots) {
            if (missingSlots.includes('location')) {
                return '×‘××™×–×” ×¢×™×¨ ××• ×™×™×©×•×‘ ××ª×” ××¢×•× ×™×™×Ÿ? ğŸ™ï¸';
            }
            if (missingSlots.includes('facility_type')) {
                const availableTypes = getAvailableFacilityTypes();
                let facilityPrompt = '××™×–×” ×¡×•×’ ××ª×§×Ÿ ×¡×¤×•×¨×˜ ××ª×” ××—×¤×©? ğŸƒâ€â™‚ï¸<br><br>';
                
                if (availableTypes.length > 0) {
                    facilityPrompt += 'ğŸ’¡ <strong>×“×•×’×××•×ª ×œ××ª×§× ×™× ×–××™× ×™×:</strong><br>';
                    const examples = availableTypes.slice(0, 6);
                    facilityPrompt += examples.map(type => `â€¢ ${type}`).join('<br>');
                    facilityPrompt += '<br><br>ğŸ’¬ ×¤×©×•×˜ ×›×ª×•×‘ ××” ××ª×” ××—×¤×©!';
                }
                
                return facilityPrompt;
            }
            if (missingSlots.includes('time')) {
                return '××ª×™ ××ª×” ×¨×•×¦×” ×œ×”×ª×××Ÿ? â°<br><br>ğŸ’¬ ×œ×“×•×’××”: "×¢×›×©×™×•", "××—×¨ ×‘×‘×•×§×¨", "×”×™×•× ×‘×¢×¨×‘", "×‘×¢×•×“ ×©×¢×”"';
            }
            if (missingSlots.includes('accessibility')) {
                return '×”×× ×™×© ×¦×•×¨×š ×‘× ×’×™×©×•×ª ×œ×× ×©×™× ×¢× ××•×’×‘×œ×•×™×•×ª? (×›×Ÿ/×œ×) â™¿';
            }
            if (missingSlots.includes('parking')) {
                return '×”×× ×—×©×•×‘ ×œ×š ×©×™×”×™×” ×—× ×™×”? (×›×Ÿ/×œ×) ğŸš—';
            }
            if (missingSlots.includes('lighting')) {
                return '×”×× ×™×© ×¦×•×¨×š ×‘×ª××•×¨×”? (×›×Ÿ/×œ×) ğŸ’¡';
            }
            return null;
        }

        function getAvailableFacilityTypes() {
            if (!sportsData || sportsData.length === 0) return [];
            
            const types = [...new Set(sportsData.map(f => f['×¡×•×’ ××ª×§×Ÿ']).filter(Boolean))];
            return types.slice(0, 10); // Return top 10 types
        }

        function filterFacilities() {
            if (!sportsData || sportsData.length === 0) return [];
            
            return sportsData.filter(facility => {
                if (conversationState.slots.location) {
                    const targetLocation = conversationState.slots.location.toLowerCase();
                    const facilityLocation = (facility['×™×©×•×‘'] || '').toLowerCase();
                    if (!facilityLocation.includes(targetLocation)) return false;
                }
                
                if (conversationState.slots.facility_type) {
                    const targetTypes = FACILITY_MAPPINGS[conversationState.slots.facility_type] || [];
                    const facilityType = (facility['×¡×•×’ ××ª×§×Ÿ'] || '').toLowerCase();
                    
                    const matches = targetTypes.some(type => 
                        facilityType.includes(type.toLowerCase())
                    );
                    
                    if (!matches) return false;
                }
                
                if (conversationState.slots.time) {
                    const availability = facility['×¤× ×•×™ ×œ×¤×¢×™×œ×•×ª'] || '';
                    const timeCompatible = checkTimeCompatibility(conversationState.slots.time, availability);
                    if (!timeCompatible.compatible) return false;
                }
                
                if (conversationState.slots.accessibility === '×›×Ÿ') {
                    const accessibility = (facility['× ×’×™×©×•×ª ×œ× ×›×™×'] || '').toLowerCase();
                    if (!accessibility.includes('×›×Ÿ')) return false;
                }
                
                if (conversationState.slots.parking === '×›×Ÿ') {
                    const parking = (facility['×—× ×™×” ×œ×¨×›×‘×™×'] || '').toLowerCase();
                    if (!parking.includes('×›×Ÿ')) return false;
                }
                
                if (conversationState.slots.lighting === '×›×Ÿ') {
                    const lighting = (facility['×ª××•×¨×” ×§×™×™××ª'] || '').toLowerCase();
                    if (!lighting.includes('×›×Ÿ')) return false;
                }
                
                return true;
            });
        }

        function checkTimeCompatibility(requestedTime, facilityAvailability) {
            const availability = facilityAvailability.toLowerCase();
            
            if (availability.includes('×‘×ª×™××•×') || availability.includes('×ª×™××•×')) {
                return { 
                    compatible: true, 
                    note: '×–××™×Ÿ ×‘×ª×™××•× ××¨××© ×‘×œ×‘×“' 
                };
            }
            
            if (availability.includes('×¤×ª×•×— ×œ×§×”×œ') || availability.includes('×¤×ª×•×—')) {
                return { compatible: true, note: null };
            }
            
            const timeMap = {
                '×‘×•×§×¨': ['×‘×•×§×¨', '×©×¢×•×ª ×”×‘×•×§×¨', '06:', '07:', '08:', '09:', '10:', '11:'],
                '×¦×”×¨×™×™×': ['×¦×”×¨×™×™×', '××—×¨ ×”×¦×”×¨×™×™×', '12:', '13:', '14:', '15:', '16:', '17:'],
                '×¢×¨×‘': ['×¢×¨×‘', '×©×¢×•×ª ×”×¢×¨×‘', '18:', '19:', '20:', '21:', '22:'],
                '×œ×™×œ×”': ['×œ×™×œ×”', '×©×¢×•×ª ×”×œ×™×œ×”', '23:', '00:', '01:', '02:', '03:', '04:', '05:']
            };
            
            if (availability.includes('×¨×§') || availability.includes('××—×¨ ×”×¦×”×¨×™×™×') || 
                availability.includes('×‘×•×§×¨') || availability.includes('×¢×¨×‘')) {
                
                const requestedTimeCategory = requestedTime;
                const patterns = timeMap[requestedTimeCategory] || [requestedTimeCategory];
                
                const hasMatch = patterns.some(pattern => availability.includes(pattern));
                
                if (!hasMatch) {
                    if (availability.includes('×¨×§ ×‘×•×§×¨') && ['×¢×¨×‘', '×œ×™×œ×”', '×¦×”×¨×™×™×'].includes(requestedTimeCategory)) {
                        return { 
                            compatible: false, 
                            note: `×”××ª×§×Ÿ ×¤×ª×•×— ×¨×§ ×‘×©×¢×•×ª ×”×‘×•×§×¨, ×œ× ×–××™×Ÿ ${getTimeDisplayName(requestedTimeCategory)}` 
                        };
                    }
                    if (availability.includes('×¨×§ ×¢×¨×‘') && ['×‘×•×§×¨', '×¦×”×¨×™×™×'].includes(requestedTimeCategory)) {
                        return { 
                            compatible: false, 
                            note: `×”××ª×§×Ÿ ×¤×ª×•×— ×¨×§ ×‘×©×¢×•×ª ×”×¢×¨×‘, ×œ× ×–××™×Ÿ ${getTimeDisplayName(requestedTimeCategory)}` 
                        };
                    }
                    if (availability.includes('××—×¨ ×”×¦×”×¨×™×™×') && requestedTimeCategory === '×‘×•×§×¨') {
                        return { 
                            compatible: false, 
                            note: '×”××ª×§×Ÿ ×¤×ª×•×— ×¨×§ ××—×¨ ×”×¦×”×¨×™×™×, ×œ× ×–××™×Ÿ ×‘×‘×•×§×¨' 
                        };
                    }
                }
            }
            
            return { compatible: true, note: null };
        }

        function displayPaginatedResults(facilities, startFromBeginning = true) {
            if (startFromBeginning) {
                conversationState.searchResults = facilities;
                conversationState.currentPage = 0;
            }
            
            const isFirstPage = conversationState.currentPage === 0;
            const pageSize = isFirstPage ? conversationState.resultsPerPage : conversationState.showMorePerPage;
            
            const startIndex = isFirstPage ? 0 : conversationState.resultsPerPage + (conversationState.currentPage - 1) * conversationState.showMorePerPage;
            const endIndex = startIndex + pageSize;
            const currentPageResults = conversationState.searchResults.slice(startIndex, endIndex);
            
            if (currentPageResults.length === 0) {
                addMessage('×–×” ×›×œ ×”××ª×§× ×™× ×©××¦××ª×™! ğŸ˜Š', 'bot');
                return;
            }
            
            if (conversationState.currentPage === 0) {
                const totalResults = conversationState.searchResults.length;
                let resultsMessage = totalResults === 1 ? 
                    'ğŸ¯ ××¦××ª×™ ××ª ×”××ª×§×Ÿ ×”××•×©×œ× ×‘×©×‘×™×œ×š:' :
                    `ğŸ¯ ××¦××ª×™ ${totalResults} ××ª×§× ×™× ×©××ª××™××™× ×œ×‘×§×©×ª×š. ××¦×™×’ ${Math.min(3, totalResults)} ×¨××©×•× ×™×:`;
                addMessage(resultsMessage, 'bot');
            }
            
            currentPageResults.forEach((facility, index) => {
                setTimeout(() => {
                    addMessage(createFacilityCard(facility), 'bot');
                }, index * 200);
            });
            
            const remainingResults = conversationState.searchResults.length - endIndex;
            
            if (remainingResults > 0) {
                setTimeout(() => {
                    const showMoreButton = `
                        <div class="show-more-btn" onclick="showMoreResults()">
                            ğŸ‘‰ ×”×¦×’ ×¢×•×“ ${Math.min(remainingResults, conversationState.showMorePerPage)} ××ª×§× ×™× ğŸ”
                        </div>
                        <div style="text-align: center; font-size: 12px; color: #666; margin-top: 5px;">
                            ×¢×•×“ ${remainingResults} ××ª×§× ×™× ×–××™× ×™×
                        </div>
                    `;
                    addMessage(showMoreButton, 'bot');
                }, currentPageResults.length * 200 + 500);
            }
            
            conversationState.currentPage++;
        }

        function showMoreResults() {
            displayPaginatedResults(null, false);
        }

        function createFacilityCard(facility) {
            const facilityName = facility['×©× ×”××ª×§×Ÿ'] || '×©× ×œ× ×–××™×Ÿ';
            const facilityType = facility['×¡×•×’ ××ª×§×Ÿ'] || '×¡×•×’ ×œ× ×¦×•×™×Ÿ';
            const city = facility['×™×©×•×‘'] || '×¢×™×¨ ×œ× ×¦×•×™× ×”';
            const phone = facility['×˜×œ×¤×•×Ÿ ××™×© ×§×©×¨'];
            const availability = facility['×¤× ×•×™ ×œ×¤×¢×™×œ×•×ª'] || '×œ× ×¦×•×™×Ÿ';
            
            const hasValidPhone = phone && phone !== '×œ× ×§×™×™×' && phone.trim() !== '';
            
            let timeNote = '';
            if (conversationState.slots.time) {
                const timeCheck = checkTimeCompatibility(conversationState.slots.time, availability);
                if (timeCheck.note) {
                    timeNote = `<br>â° ${timeCheck.note}`;
                }
            }
            
            const googleMapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(facilityName + ', ' + city)}`;
            
            return `<div class="facility-card">
                <div class="facility-name">${facilityName}</div>
                <div class="facility-type">${facilityType}</div>
                <div class="facility-details">
                    ğŸ“ <strong>${city}</strong><br>
                    ${hasValidPhone ? 'ğŸ“ ' + phone + '<br>' : ''}
                    ğŸ• <strong>×–××™× ×•×ª:</strong> ${availability}${timeNote}
                </div>
                <a href="${googleMapsUrl}" target="_blank" class="facility-link">ğŸ—ºï¸ ××¤×•×ª ×’×•×’×œ</a>
                ${hasValidPhone ? `<a href="tel:${phone}" class="facility-link">ğŸ“ ×”×ª×§×©×¨</a>` : ''}
            </div>`;
        }

        async function processMessage(message) {
            if (!isDataLoaded) {
                if (!isOnline) {
                    addMessage('ğŸ“¡ ××™×Ÿ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•×¨×¢× ×Ÿ ××ª ×”×“×£.', 'bot');
                } else {
                    addMessage('âš ï¸ × ×ª×•× ×™ ×”××ª×§× ×™× ×¢×“×™×™×Ÿ × ×˜×¢× ×™×. ×× × ×”××ª×Ÿ...', 'bot');
                }
                return;
            }
            
            showTypingIndicator();
            
            try {
                const intent = recognizeIntent(message);
                hideTypingIndicator();
                
                if (['greeting', 'thanks', 'how_are_you', 'what_day', 'capabilities', 'weather_specific', 'off_topic'].includes(intent)) {
                    const response = await handleSmallTalk(intent, message);
                    if (response) {
                        addMessage(response, 'bot');
                    }
                    return;
                }
                
                if (intent === 'show_more') {
                    if (conversationState.searchResults.length > 0) {
                        showMoreResults();
                    } else {
                        addMessage('××™×Ÿ ×¢×•×“ ×ª×•×¦××•×ª ×œ×”×¦×™×’. ×‘×•× × ×—×¤×© ××©×”×• ×—×“×©! ğŸ˜Š', 'bot');
                    }
                    return;
                }
                
                if (intent === 'search_facility') {
                    if (conversationState.intent === null) {
                        conversationState.intent = 'search_facility';
                    }
                    
                    const entities = extractEntities(message);
                    updateSlots(entities);
                    
                    const hasBasicInfo = conversationState.slots.location && conversationState.slots.facility_type;
                    
                    if (hasBasicInfo && !conversationState.weatherChecked && 
                        OUTDOOR_FACILITIES.includes(conversationState.slots.facility_type)) {
                        
                        addMessage('×¨×’×¢ ××—×“, ×‘×•×“×§ ××ª ××–×’ ×”××•×•×™×¨... ğŸŒ¤ï¸', 'bot');
                        showTypingIndicator();
                        
                        const weatherData = await getWeatherData(conversationState.slots.location);
                        conversationState.weatherData = weatherData;
                        conversationState.weatherChecked = true;
                        
                        hideTypingIndicator();
                        
                        if (weatherData) {
                            const contextualFeedback = getContextualWeatherFeedback(weatherData);
                            if (contextualFeedback) {
                                addMessage(contextualFeedback, 'bot');
                            }
                        } else {
                            addMessage('×œ× ×”×¦×œ×—×ª×™ ×œ×§×‘×œ × ×ª×•× ×™ ××–×’ ××•×•×™×¨, ××‘×œ ×××©×™×š ×œ×—×¤×© ××ª×§× ×™×! ğŸŒ¤ï¸', 'bot');
                        }
                    }
                    
                    if (conversationState.weatherChecked && message.toLowerCase().includes('××§×•×¨×”')) {
                        conversationState.slots.facility_type = '××•×œ×';
                        addMessage('××¢×•×œ×”! ××—×¤×© ×œ×š ××ª×§×Ÿ ××§×•×¨×”... ğŸ¢', 'bot');
                    }
                    
                    const missingSlots = getMissingSlots();
                    
                    if (missingSlots.length > 0) {
                        const question = askForMissingInfo(missingSlots);
                        if (question) {
                            addMessage(question, 'bot');
                            return;
                        }
                    }
                    
                    const facilities = filterFacilities();
                    
                    if (facilities.length > 0) {
                        displayPaginatedResults(facilities, true);
                    } else {
                        addMessage('×œ× ××¦××ª×™ ××ª×§× ×™× ×©××ª××™××™× ×œ×‘×§×©×ª×š. ğŸ˜”<br><br>ğŸ’¡ × ×¡×” ×œ×©× ×•×ª ××ª ×”×§×¨×™×˜×¨×™×•× ×™× ××• ×œ×›×ª×•×‘ ×‘×§×©×” ××—×¨×ª.', 'bot');
                    }
                    
                    conversationState = {
                        intent: null,
                        slots: {
                            location: null,
                            facility_type: null,
                            accessibility: null,
                            parking: null,
                            lighting: null,
                            time: null
                        },
                        weatherChecked: false,
                        weatherData: null,
                        searchResults: [],
                        currentPage: 0,
                        resultsPerPage: 3,
                        showMorePerPage: 10
                    };
                }
                
            } catch (error) {
                hideTypingIndicator();
                console.error('Error processing message:', error);
                addMessage('âš ï¸ ××¦×˜×¢×¨, ××™×¨×¢×” ×©×’×™××”. ×× × × ×¡×” ×©×•×‘.', 'bot');
            }
        }

        // UI functions
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message && isDataLoaded) {
                addMessage(message, 'user');
                input.value = '';
                setTimeout(() => processMessage(message), 500);
            }
        }

        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            bubbleDiv.innerHTML = content;
            
            messageDiv.appendChild(bubbleDiv);
            messagesContainer.insertBefore(messageDiv, document.getElementById('typingIndicator'));
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'block';
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function updateStatusBadge(text) {
            document.getElementById('statusBadge').textContent = text;
        }

        function enableInterface() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').placeholder = '×›×ª×•×‘ ××” ××ª×” ××—×¤×©...';
        }

        function startNewConversation() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingIndicator = document.getElementById('typingIndicator');
            
            while (messagesContainer.firstChild && messagesContainer.firstChild !== typingIndicator) {
                messagesContainer.removeChild(messagesContainer.firstChild);
            }
            
            conversationState = {
                intent: null,
                slots: {
                    location: null,
                    facility_type: null,
                    accessibility: null,
                    parking: null,
                    lighting: null,
                    time: null
                },
                weatherChecked: false,
                weatherData: null,
                searchResults: [],
                currentPage: 0,
                resultsPerPage: 3,
                showMorePerPage: 10
            };
            
            setTimeout(() => {
                addMessage(`×©×œ×•×! ××™×š ×× ×™ ×™×›×•×œ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×? ğŸ˜Š<br><br>
                    ×× ×™ SportsBuddy - ×”×‘×•×˜ ×©××ª××—×” ×‘××¦×™××ª ××ª×§× ×™ ×¡×¤×•×¨×˜ ×‘×™×©×¨××œ ×¢× ××–×’ ××•×•×™×¨ ×—×›×!<br><br>
                    ğŸ’¬ <strong>×“×•×’×××•×ª:</strong><br>
                    ğŸŠâ€â™‚ï¸ "×‘×¨×™×›×” ×‘×ª×œ ××‘×™×‘"<br>
                    âš½ "××’×¨×© ×›×“×•×¨×’×œ ×‘×—×™×¤×”"<br>
                    ğŸŒ¤ï¸ "××–×’ ×”××•×•×™×¨ ×‘×™×¨×•×©×œ×™×"<br>
                    ğŸƒâ€â™‚ï¸ "××•×œ× ×¡×¤×•×¨×˜ × ×’×™×© ×‘×¨×—×•×‘×•×ª"<br><br>
                    <strong>×¤×©×•×˜ ×›×ª×•×‘ ××” ××ª×” ××—×¤×©!</strong>`, 'bot');
            }, 500);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ SportsBuddy AI - Global Version Initializing...');
            console.log('ğŸ“ Data URL:', CONFIG.DATA_URL);
            
            // Update connection status immediately
            updateConnectionStatus(isOnline);
            
            // Load data
            await loadSportsData();
        });

        // Make functions globally accessible
        window.handleKeyPress = handleKeyPress;
        window.sendMessage = sendMessage;
        window.startNewConversation = startNewConversation;
        window.showMoreResults = showMoreResults;
    </script>
</body>
</html>
